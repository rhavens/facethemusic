<!DOCTYPE html>
<html>
<head>
    <title>FaceMusic</title>
    <meta charset=utf-8 />
    <!-- icon -->
    <link rel='shortcut icon' href='favicon.ico' />
    <!-- smiley face logo credit erin heaton -->  
    <!-- FONTS -->
    <!-- Signika Negative (ViaSat font) -->
    <link href='//fonts.googleapis.com/css?family=Signika+Negative:400,300,600,700' rel='stylesheet' type='text/css'>
    <!-- Font Awesome (Icons) -->
    <link rel='stylesheet' href='//maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css'>
    <!-- SCRIPTS -->
    <!-- jQuery -->
    <script src='//code.jquery.com/jquery-2.2.4.min.js'></script>  
    <!-- Local JS -->
    <script src='js/shared.js'></script>
    <script src='js/index.js'></script>
    <!-- d3js -->
    <script src='//d3js.org/d3.v3.min.js'></script>
    <!-- Bootstrap CSS -->
    <link rel='stylesheet' href='//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css' />
    <!-- Bootstrap JS -->
    <script src='//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js'></script>
    <!-- Local CSS -->
    <link rel='stylesheet' href='css/shared.css' />
    <link rel='stylesheet' href='css/index.css' />
</head>

<body style='overflow:hidden;margin:0;'>
  <div class="nav-container">
    <img class='nav-logo' src="img/logo-alt.png">
    <h1 class="page-title-buffer">|||</h1>
    <h1 class="page-title">face.the.music</h1>
    <h3 class='page-subtitle'>play the tunes you feel</h3>
  </div>
  <div id='program-body'>
    <div class='container webcam-container'>
      <div class='webcam-inner'>
        <h1>Sample Text</h1>
      </div>
    </div>
    <div class='container spotify-container'>
      <div class='webcam-inner'>
        <h1>Sample Text</h1>
      </div>
    </div>
    <div class='container album-body'>
      <div class='row'></div>
      <div class='row'></div>
      <div class='row'></div>
      <div class='row'></div>
    </div>
  </div>
  <div class="container">
    <div id="login">
      <h1>This is an example of the Authorization Code flow</h1>
      <a href="/login" class="btn btn-primary">Log in with Spotify</a>
    </div>
    <div id="loggedin">
      <div id="user-profile">
      </div>
      <div id="oauth">
      </div>
      <button class="btn btn-default" id="obtain-new-token">Obtain new token using the refresh token</button>
    </div>
  </div>

  <script>
    (function() {

      var userProfileSource = document.getElementById('user-profile-template').innerHTML,
          userProfileTemplate = Handlebars.compile(userProfileSource),
          userProfilePlaceholder = document.getElementById('user-profile');

      var oauthSource = document.getElementById('oauth-template').innerHTML,
          oauthTemplate = Handlebars.compile(oauthSource),
          oauthPlaceholder = document.getElementById('oauth');

      var cs_access_token, cs_refresh_token;
      <% if (locals.access_token) { %>
        console.log('wtf');
        cs_access_token = '<%= access_token %>';
        cs_refresh_token = '<%= refresh_token %>';
        localStorage.setItem('cs_access_token',cs_access_token);
        localStorage.setItem('cs_refresh_token',cs_refresh_token);
      <% } %>
      <% if (locals.error) { %>
        console.log('<%= error %>');
      <% } %>
      console.log(cs_access_token,cs_refresh_token);

      if (cs_access_token) {
          // render oauth info
          oauthPlaceholder.innerHTML = oauthTemplate({
            cs_access_token: cs_access_token,
            cs_refresh_token: cs_refresh_token
          });

          $.ajax({
              url: 'https://api.spotify.com/v1/me',
              headers: {
                'Authorization': 'Bearer ' + cs_access_token
              },
              success: function(response) {
                  userProfilePlaceholder.innerHTML = userProfileTemplate(response);

                  $('#login').hide();
                  $('#loggedin').show();
              }
          });
        } else {
            // render initial screen
            $('#login').show();
            $('#loggedin').hide();
        }

        document.getElementById('obtain-new-token').addEventListener('click', function() {
          $.ajax({
            url: '/refresh_token',
            data: {
              'refresh_token': cs_refresh_token
            }
          }).done(function(data) {
            cs_access_token = data.access_token;
            localStorage.setItem('cs_access_token',cs_access_token);
            oauthPlaceholder.innerHTML = oauthTemplate({
              cs_access_token: cs_access_token,
              cs_refresh_token: cs_refresh_token
            });
          });
        }, false);
    })();
  </script>
</body>
</html>

