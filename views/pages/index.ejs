<!DOCTYPE html>
<html>
<head>
    <title>FaceMusic</title>
    <meta charset=utf-8 />
    <!-- icon -->
    <link rel='shortcut icon' href='favicon.ico' />
    <!-- smiley face logo credit erin heaton -->  
    <!-- Local CSS -->
    <link rel='stylesheet' href='css/shared.css' />
    <link rel='stylesheet' href='css/index.css' />
    <!-- FONTS -->
    <!-- Signika Negative (ViaSat font) -->
    <link href='http://fonts.googleapis.com/css?family=Signika+Negative:400,300,600,700' rel='stylesheet' type='text/css'>
    <!-- Font Awesome (Icons) -->
    <link rel='stylesheet' href='http://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css'>
    <!-- SCRIPTS -->
    <!-- jQuery -->
    <script src='http://code.jquery.com/jquery-2.2.4.min.js'></script>  
    <!-- Local JS -->
    <script src='js/shared.js'></script>
    <script src='js/index.js'></script>
    <!-- d3js -->
    <script src='http://d3js.org/d3.v3.min.js'></script>
    <!-- Bootstrap CSS -->
    <link rel='stylesheet' href='http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css' />
    <!-- Bootstrap JS -->
    <script src='http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js'></script>
</head>

<body style='overflow:hidden;margin:0;'>
  <div class="container">
    <div id="login">
      <h1>This is an example of the Authorization Code flow</h1>
      <a href="/login" class="btn btn-primary">Log in with Spotify</a>
    </div>
    <div id="loggedin">
      <div id="user-profile">
      </div>
      <div id="oauth">
      </div>
      <button class="btn btn-default" id="obtain-new-token">Obtain new token using the refresh token</button>
    </div>
  </div>

  <script id="user-profile-template" type="text/x-handlebars-template">
    <h1>Logged in as {{display_name}}</h1>
    <div class="media">
      <div class="pull-left">
        <img class="media-object" width="150" src="{{images.0.url}}" />
      </div>
      <div class="media-body">
        <dl class="dl-horizontal">
          <dt>Display name</dt><dd class="clearfix">{{display_name}}</dd>
          <dt>Id</dt><dd>{{id}}</dd>
          <dt>Email</dt><dd>{{email}}</dd>
          <dt>Spotify URI</dt><dd><a href="{{external_urls.spotify}}">{{external_urls.spotify}}</a></dd>
          <dt>Link</dt><dd><a href="{{href}}">{{href}}</a></dd>
          <dt>Profile Image</dt><dd class="clearfix"><a href="{{images.0.url}}">{{images.0.url}}</a></dd>
          <dt>Country</dt><dd>{{country}}</dd>
        </dl>
      </div>
    </div>
  </script>

  <script id="oauth-template" type="text/x-handlebars-template">
    <h2>oAuth info</h2>
    <dl class="dl-horizontal">
      <dt>Access token</dt><dd class="text-overflow">{{cs_access_token}}</dd>
      <dt>Refresh token</dt><dd class="text-overflow">{{cs_refresh_token}}></dd>
    </dl>
  </script>

  <script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0-alpha.1/handlebars.min.js"></script>
  <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
  <script>
    (function() {

      var userProfileSource = document.getElementById('user-profile-template').innerHTML,
          userProfileTemplate = Handlebars.compile(userProfileSource),
          userProfilePlaceholder = document.getElementById('user-profile');

      var oauthSource = document.getElementById('oauth-template').innerHTML,
          oauthTemplate = Handlebars.compile(oauthSource),
          oauthPlaceholder = document.getElementById('oauth');

      var cs_access_token, cs_refresh_token;
      <% if (locals.access_token) { %>
        console.log('wtf');
        cs_access_token = '<%= access_token %>';
        cs_refresh_token = '<%= refresh_token %>';
        localStorage.setItem('cs_access_token',cs_access_token);
        localStorage.setItem('cs_refresh_token',cs_refresh_token);
      <% } %>
      <% if (locals.error) { %>
        console.log('<%= error %>');
      <% } %>
      console.log(cs_access_token,cs_refresh_token);

      if (cs_access_token) {
          // render oauth info
          oauthPlaceholder.innerHTML = oauthTemplate({
            cs_access_token: cs_access_token,
            cs_refresh_token: cs_refresh_token
          });

          $.ajax({
              url: 'https://api.spotify.com/v1/me',
              headers: {
                'Authorization': 'Bearer ' + cs_access_token
              },
              success: function(response) {
                  userProfilePlaceholder.innerHTML = userProfileTemplate(response);

                  $('#login').hide();
                  $('#loggedin').show();
              }
          });
        } else {
            // render initial screen
            $('#login').show();
            $('#loggedin').hide();
        }

        document.getElementById('obtain-new-token').addEventListener('click', function() {
          $.ajax({
            url: '/refresh_token',
            data: {
              'refresh_token': cs_refresh_token
            }
          }).done(function(data) {
            cs_access_token = data.access_token;
            localStorage.setItem('cs_access_token',cs_access_token);
            oauthPlaceholder.innerHTML = oauthTemplate({
              cs_access_token: cs_access_token,
              cs_refresh_token: cs_refresh_token
            });
          });
        }, false);
    })();
  </script>
</body>
</html>

